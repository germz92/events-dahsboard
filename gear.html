<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gear Checklist</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 40px;
      color: #333;
    }
    h1, h2 {
      text-align: center;
    }
    .gear-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 20px 0;
    }
    .category {
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 220px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    .category h3 {
      margin: 0 0 12px 0;
      font-size: 1.1rem;
      color: #3f51b5;
    }
    .item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      gap: 6px;
    }
    .item input[type="text"] {
      flex: 1;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.95rem;
    }
    .item input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }
    .add-btn {
      background: #3f51b5;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 12px;
    }
    .add-btn:hover {
      background: #2c3ea8;
    }
  </style>
</head>
<body>
  <button onclick="goBack()" style="margin-bottom: 20px; background: #ccc; padding: 10px 16px; border-radius: 6px; border: none; cursor: pointer;">â¬… Back</button>
  <h2 id="eventTitle" style="margin-bottom: 30px;"></h2>
  <h1>Gear Checklist</h1>
  <div class="gear-container" id="gearContainer"></div>

  <script>
    const categories = ["Cameras", "Lenses", "Lighting", "Support", "Accessories"];
    const token = localStorage.getItem('token');
    const params = new URLSearchParams(window.location.search);
    const tableId = params.get('id');
    let savedGear = {};

    function goBack() {
      window.location.href = `event.html?id=${tableId}`;
    }

    async function loadGear() {
      try {
        const res = await fetch(`http://localhost:3000/api/tables/${tableId}/gear`, {
          headers: { Authorization: token }
        });
        if (!res.ok) throw new Error("Failed to fetch gear");

        savedGear = await res.json();
        const eventRes = await fetch(`http://localhost:3000/api/tables/${tableId}`, {
          headers: { Authorization: token }
        });
        if (eventRes.ok) {
          const table = await eventRes.json();
          document.getElementById('eventTitle').textContent = table.title;
        }
        categories.forEach(createCategory);
      } catch (err) {
        console.error("Error loading gear:", err);
        document.body.innerHTML = "<h2 style='text-align:center;color:red;'>Failed to load gear data.</h2>";
      }
    }

    function createCategory(name) {
      const section = document.createElement("div");
      section.className = "category";
      section.innerHTML = `<h3>${name}</h3><div class="item-list"></div>`;
      const list = section.querySelector(".item-list");

      (savedGear[name] || []).forEach(item => {
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `<input type='checkbox' ${item.checked ? 'checked' : ''}><input type='text' value="${item.label}" />`;
        list.appendChild(el);
      });

      const addBtn = document.createElement("button");
      addBtn.className = "add-btn";
      addBtn.textContent = "+ Add Item";
      addBtn.onclick = () => {
        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = "<input type='checkbox'><input type='text' />";
        list.appendChild(row);
      };

      section.appendChild(addBtn);
      document.getElementById("gearContainer").appendChild(section);
    }

    async function saveGear() {
      const data = {};
      document.querySelectorAll(".category").forEach(section => {
        const name = section.querySelector("h3").textContent;
        const items = Array.from(section.querySelectorAll(".item-list .item")).map(row => {
          const text = row.querySelector("input[type='text']").value.trim();
          const checked = row.querySelector("input[type='checkbox']").checked;
          return text ? { label: text, checked } : null;
        }).filter(Boolean);
        data[name] = items;
      });

      await fetch(`http://localhost:3000/api/tables/${tableId}/gear`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          Authorization: token
        },
        body: JSON.stringify(data)
      });
    }

    window.addEventListener("beforeunload", saveGear);
    window.addEventListener("DOMContentLoaded", loadGear);
  </script>
</body>
</html>

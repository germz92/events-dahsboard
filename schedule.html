<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Program Schedule</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 20px;
    }

    h1, h2 {
      text-align: center;
    }

    .top-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .program-container {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }

    .date-section {
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      width: 350px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
    }

    .date-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 10px;
    }

    .date-header button {
      background: none;
      border: none;
      color: #d11a2a;
      font-size: 20px;
      cursor: pointer;
    }

    .program-entry {
      background: #d3d3d3;
      padding: 12px;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
    }

    .program-entry input,
    .program-entry textarea {
      width: 100%;
      border: none;
      background: transparent;
      font-size: 14px;
      font-family: inherit;
      color: black;
      outline: none;
      cursor: text;
    }

    .program-entry input.editing,
    .program-entry textarea.editing {
      border: 1px solid #007BFF;
      background: white;
    }

    .program-name {
      font-weight: bold;
      font-size: 14px;
    }

    .add-btn {
      margin-top: 10px;
      padding: 8px 16px;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      width: 200px;
    }

    .add-btn:hover {
      background: #0056b3;
    }

    .delete-btn {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: none;
      border: none;
      font-size: 18px;
      color: #d11a2a;
      cursor: pointer;
    }

    .show-notes-btn {
      color: #007BFF;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 13px;
      text-decoration: underline;
      padding: 0;
      width: fit-content;
    }

    @media (max-width: 768px) {
      .program-container {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
    <button onclick="goBack()" style="background: #ccc; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer;">‚¨Ö Back</button>
  <h2 id="eventTitle"></h2>
  <h1>Program Schedule</h1>

  <div class="top-controls">
    <input type="date" id="newDate">
    <button class="add-btn" onclick="addDateSection()">+ Add Date</button>
  </div>

  <div id="programSections" class="program-container"></div>

  <script src="js/config.js"></script>
  <script>
      let tableData = { programs: [] };
      const params = new URLSearchParams(window.location.search);
      const tableId = params.get('id');
      let saveTimeout;
  
      function formatDate(dateStr) {
        const [year, month, day] = dateStr.split('-');
        const d = new Date(year, month - 1, day);
        return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
      }
  
      async function loadPrograms() {
        try {
          const res = await fetch(`${API_BASE}/api/tables/${tableId}/program-schedule`, {
            headers: {
              Authorization: localStorage.getItem('token')
            }
          });
          const data = await res.json();
          tableData.programs = data.programSchedule || [];
          renderProgramSections();
        } catch (err) {
          console.error('Failed to load programs:', err);
          tableData.programs = [];
          renderProgramSections(); // still render even if failed
        }
      }
  
      async function savePrograms() {
        try {
          await fetch(`${API_BASE}/api/tables/${tableId}/program-schedule`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              Authorization: localStorage.getItem('token')
            },
            body: JSON.stringify({ programSchedule: tableData.programs })
          });
          console.log('Programs saved!');
        } catch (err) {
          console.error('Failed to save programs:', err);
        }
      }
  
      function scheduleSave() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(savePrograms, 2000);
      }
  
      function renderProgramSections() {
        const container = document.getElementById('programSections');
        if (!container) {
          console.error('Missing #programSections div!');
          return;
        }
        container.innerHTML = '';
  
        if (tableData.programs.length === 0) {
          const empty = document.createElement('div');
          empty.textContent = 'No programs yet. Add a new date to get started.';
          empty.style.textAlign = 'center';
          empty.style.padding = '40px';
          empty.style.color = '#777';
          container.appendChild(empty);
          return;
        }
  
        const dates = [...new Set(tableData.programs.map(p => p.date))].sort((a, b) => a.localeCompare(b));
  
        dates.forEach(date => {
          const section = document.createElement('div');
          section.className = 'date-section';
          section.setAttribute('data-date', date);
  
          const headerWrapper = document.createElement('div');
          headerWrapper.className = 'date-header';
          headerWrapper.innerHTML = `
            <div>${formatDate(date)}</div>
            <button onclick="deleteDate('${date}')">üóëÔ∏è</button>
          `;
          section.appendChild(headerWrapper);
  
          tableData.programs.filter(p => p.date === date).forEach((program, index) => {
            const entry = document.createElement('div');
            entry.className = 'program-entry';
            entry.innerHTML = `
              <input class="program-name" type="text" placeholder="Program Name" value="${program.name || ''}" 
                onfocus="enableEdit(this)" onblur="autoSave(this, '${date}', ${index}, 'name')">
              <div style="display:flex;gap:1px;">
                <input type="time" value="${program.startTime || ''}" 
                  onfocus="enableEdit(this)" onblur="autoSave(this, '${date}', ${index}, 'startTime')">
                <input type="time" value="${program.endTime || ''}" 
                  onfocus="enableEdit(this)" onblur="autoSave(this, '${date}', ${index}, 'endTime')">
              </div>
              <input type="text" placeholder="Location" value="${program.location || ''}" 
                onfocus="enableEdit(this)" onblur="autoSave(this, '${date}', ${index}, 'location')">
              <input type="text" placeholder="Photographer" value="${program.photographer || ''}" 
                onfocus="enableEdit(this)" onblur="autoSave(this, '${date}', ${index}, 'photographer')">
              <button class="show-notes-btn" onclick="toggleNotes(this)">Show Notes</button>
              <div class="notes-field" style="display:none;">
                <textarea placeholder="Notes" 
                  onfocus="enableEdit(this)" 
                  oninput="autoResizeTextarea(this)" 
                  onblur="autoSave(this, '${date}', ${index}, 'notes')">${program.notes || ''}</textarea>
              </div>
              <button class="delete-btn" onclick="deleteProgram('${date}', ${index})">üóëÔ∏è</button>
            `;
            section.appendChild(entry);
          });
  
          const addBtn = document.createElement('button');
          addBtn.className = 'add-btn';
          addBtn.textContent = '+ Add Row';
          addBtn.onclick = () => addProgram(date);
          section.appendChild(addBtn);
  
          container.appendChild(section);
        });
      }
  
      function enableEdit(field) {
        field.classList.add('editing');
      }
  
      function autoSave(field, date, index, key) {
        field.classList.remove('editing');
        const programIndex = tableData.programs.findIndex(
          (p, i) => p.date === date && i === index
        );
        if (programIndex !== -1) {
          tableData.programs[programIndex][key] = field.value.trim();
          scheduleSave();
        }
      }
  
      function toggleNotes(button) {
        const notesField = button.nextElementSibling;
        if (notesField.style.display === 'none' || notesField.style.display === '') {
          notesField.style.display = 'block';
          button.textContent = 'Hide Notes';
        } else {
          notesField.style.display = 'none';
          button.textContent = 'Show Notes';
        }
      }
  
      function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
      }
  
      function captureCurrentPrograms() {
        const sections = document.querySelectorAll('.date-section');
        let newPrograms = [];
        sections.forEach(section => {
          const date = section.getAttribute('data-date');
          const entries = section.querySelectorAll('.program-entry');
          entries.forEach(entry => {
            const inputs = entry.querySelectorAll('input, textarea');
            newPrograms.push({
              date,
              name: inputs[0].value.trim(),
              startTime: inputs[1].value.trim(),
              endTime: inputs[2].value.trim(),
              location: inputs[3].value.trim(),
              photographer: inputs[4].value.trim(),
              notes: inputs[5].value.trim()
            });
          });
        });
        tableData.programs = newPrograms;
      }
  
      function addDateSection() {
        const date = document.getElementById('newDate').value;
        if (!date) return alert('Please select a date');
        captureCurrentPrograms();
        tableData.programs.push({
          date,
          name: '',
          startTime: '',
          endTime: '',
          location: '',
          photographer: '',
          notes: ''
        });
        document.getElementById('newDate').value = '';
        renderProgramSections();
        scheduleSave();
      }
  
      function addProgram(date) {
        captureCurrentPrograms();
        tableData.programs.push({
          date,
          name: '',
          startTime: '',
          endTime: '',
          location: '',
          photographer: '',
          notes: ''
        });
        renderProgramSections();
        scheduleSave();
      }
  
      function deleteProgram(date, index) {
        tableData.programs = tableData.programs.filter((p, i) => !(p.date === date && i === index));
        renderProgramSections();
        scheduleSave();
      }
  
      function deleteDate(date) {
        if (confirm('Delete all programs for this date?')) {
          tableData.programs = tableData.programs.filter(p => p.date !== date);
          renderProgramSections();
          scheduleSave();
        }
      }
  
      window.addEventListener('DOMContentLoaded', () => {
        loadPrograms();
      });

      function goBack() {
      window.location.href = `event.html?id=${tableId}`;
    }
  </script>
  
</body>
</html>
